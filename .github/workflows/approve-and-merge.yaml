name: Auto-approve & auto-merge Dependabot PRs

on:
  schedule:
    - cron: "0 3 * * *" # Every day at 3 AM UTC
  workflow_dispatch:
  workflow_call:

permissions:
  pull-requests: write
  contents: write

concurrency:
  group: ${{ github.ref_name }}-approve-and-merge
  cancel-in-progress: true

jobs:
  approve-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Approve & Merge Dependabot PRs
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          # Add label
          if ! gh label list --repo "$GITHUB_REPOSITORY" --limit 100 | grep -q auto-approved; then
            echo "Label auto-approved does not exist. Creating it..."
            gh label create auto-approved --repo "$GITHUB_REPOSITORY" --color "0e8a16" --description "Automatically approved and merged by workflow"
          else
            echo "Label auto-approved already exists. Skipping creation."
          fi
          echo "Fetching open Dependabot PRs older than 3 days..."

          # Get PRs by dependabot, filter by age
          gh pr list --repo "$GITHUB_REPOSITORY" --author app/dependabot --state open --json number,createdAt,title --jq '.[] | select((.createdAt | fromdateiso8601) < (now - 259200) and .reviewDecision == "REVIEW_REQUIRED")' | jq -c '.' | while read pr; do
            number=$(echo "$pr" | jq -r '.number')
            title=$(echo "$pr" | jq -r '.title')

            echo "ðŸ‘‰ Processing PR #$number: $title"

            gh pr review "$number" --repo "$GITHUB_REPOSITORY" --approve
            gh pr merge "$number" --repo "$GITHUB_REPOSITORY" --squash --auto
            gh pr edit "$number" --repo "$GITHUB_REPOSITORY" --add-label auto-approved

            echo "âœ… Done with PR #$number"
          done
