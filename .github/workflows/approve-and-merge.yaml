# Copyright 2024 Zaphiro Technologies
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Auto-approve & auto-merge Dependabot PRs

on:
  schedule:
    - cron: "0 3 * * *" # Every day at 3 AM UTC
  workflow_dispatch:
  workflow_call:

permissions:
  pull-requests: write
  contents: write

concurrency:
  group: ${{ github.ref_name }}-approve-and-merge
  cancel-in-progress: true

jobs:
  approve-and-merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v2
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_SECRET }}
      - name: Approve & Merge Dependabot PRs
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          # Add label
          if ! gh label list --repo "$GITHUB_REPOSITORY" --limit 100 | grep -q auto-approved; then
            echo "Label auto-approved does not exist. Creating it..."
            gh label create auto-approved --repo "$GITHUB_REPOSITORY" --color "0e8a16" --description "Automatically approved and merged by workflow"
          else
            echo "Label auto-approved already exists. Skipping creation."
          fi

          echo "Fetching open Dependabot PRs older than 3 days and newer than 30 days ..."

          gh pr list --repo "$GITHUB_REPOSITORY" --author app/dependabot --state open --json number,createdAt,title,labels,headRefName --jq '.[] | select((.createdAt | fromdateiso8601) < (now - 259200))' | jq -c '.' | while IFS= read -r pr; do
            number=$(echo "$pr" | jq -r '.number')
            title=$(echo "$pr" | jq -r '.title')
            labels=$(echo "$pr" | jq -r '[.labels[].name] | join(",")')
            branch=$(echo "$pr" | jq -r '.headRefName')

            echo "üëâ Processing PR #$number: $title"

            if echo "$labels" | grep -q "auto-approved"; then
              mergeable_state=$(gh pr view "$number" --repo "$GITHUB_REPOSITORY" --json mergeStateStatus --jq '.mergeStateStatus')
              if [ "$mergeable_state" = "DIRTY" ]; then
                echo "üîÑ Rebasing PR #$number branch ($branch)..."
                git config --global user.name 'Bot'
                git config --global user.email 'bot@zaphiro.ch'
                git clone "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" repo
                cd repo
                git fetch origin
                git checkout "$branch"
                base_branch=$(gh pr view "$number" --json baseRefName --jq '.baseRefName')
                
                if ! git rebase "origin/$base_branch"; then
                  echo "‚ö†Ô∏è Rebase conflict detected for PR #$number ‚Äî attempting automatic conflict resolution..."
                  # Auto-resolve RELEASE_NOTES.md in favor of base, if it exists
                  if [ -f RELEASE_NOTES.md ]; then
                    echo "üß© Auto-resolving RELEASE_NOTES.md in favor of base branch"
                    git checkout --ours RELEASE_NOTES.md
                    git add RELEASE_NOTES.md
                    git rebase --continue || true
                  fi

                  # If still conflicted, skip the commit
                  if git rebase --continue 2>/dev/null; then
                    echo "‚úÖ Conflict resolved and rebase continued."
                  elif git rebase --skip 2>/dev/null; then
                    echo "‚úÖ Conflicted commit skipped."
                  else
                    echo "‚ùå Rebase failed for PR #$number. Aborting and skipping this PR."
                    git rebase --abort || true
                    cd ..
                    rm -rf repo
                    continue
                  fi
                fi

                git push --force-with-lease origin "$branch"
                echo "‚úÖ Rebase complete and branch updated for PR #$number"
                cd ..
                rm -rf repo
              else
                echo "‚úÖ PR #$number is up to date."
              fi
              continue
            fi

            echo "üîç Checking CI status for PR #$number..."
            commit_sha=$(gh pr view "$number" --repo "$GITHUB_REPOSITORY" --json headRefOid --jq '.headRefOid')

            checks_state=$(gh api repos/$GITHUB_REPOSITORY/commits/$commit_sha/check-runs --jq '[.check_runs[].conclusion] | unique | join(",")')

            if echo "$checks_state" | grep -Eiq 'failure|timed_out|cancelled|action_required'; then
              echo "‚ùå Skipping PR #$number: one or more checks failed ($checks_state)"
              continue
            fi

            echo "üöÄ Approving and merging PR #$number"
            gh pr review "$number" --repo "$GITHUB_REPOSITORY" --approve
            gh pr merge "$number" --repo "$GITHUB_REPOSITORY" --squash --auto
            gh pr edit "$number" --repo "$GITHUB_REPOSITORY" --add-label auto-approved
            echo "‚úÖ Done with PR #$number"
          done
